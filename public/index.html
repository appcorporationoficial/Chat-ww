<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solicitar Cita</title>
<style>
body{margin:0;font-family:Arial;background:#f4f7fb;padding:20px;}
h1{text-align:center;color:#2575fc;}
form{max-width:400px;margin:auto;background:white;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.2);}
input,textarea{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:8px;}
button{width:100%;padding:12px;background:#2575fc;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;margin-top:8px;}
button:hover{background:#1d5cd6;}
#mensaje{margin-top:10px;text-align:center;color:green;}
#userInfo{max-width:400px;margin:20px auto;padding:15px;background:#e0f0ff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
#cambiarUsuario{background:#fc5252;}
#cambiarUsuario:hover{background:#d43f3f;}
</style>
</head>
<body>

<h1>Unirse a Citas</h1>

<div id="userInfo" style="display:none;"></div>

<form id="citaForm">
  <input type="text" id="username" placeholder="Tu nombre" required>
  <input type="number" id="edad" placeholder="Edad">
  <textarea id="intereses" placeholder="Tus intereses (opcional)"></textarea>
  <button type="submit">Unirse</button>
  <div id="mensaje"></div>
</form>

<script>

// Obtener user del link
const urlParams = new URLSearchParams(window.location.search);
const username = urlParams.get('user') || 'user_ejemplo'; 

const form = document.getElementById("citaForm");
const mensaje = document.getElementById("mensaje");
const userInfo = document.getElementById("userInfo");

// Función para mostrar datos del usuario registrado
function mostrarUsuario(usuario){
  userInfo.style.display = "block";
  userInfo.innerHTML = `
    <h3>Usuario Registrado:</h3>
    <p><strong>Nombre:</strong> ${usuario.name}</p>
    <p><strong>Edad:</strong> ${usuario.edad}</p>
    <p><strong>Intereses:</strong> ${usuario.intereses}</p>
    <button id="cambiarUsuario">Cambiar Usuario</button>
  `;
  form.style.display = "none";

  // Botón para cambiar usuario
  document.getElementById("cambiarUsuario").addEventListener("click", async () => {
  const usuario = JSON.parse(localStorage.getItem("usuarioCitas"));
  
  if (usuario) {
    try {
      const res = await fetch(`/citas/${usuario.username}`, {
        method: "DELETE"
      });
      const data = await res.json();
      console.log(data.message || "Usuario eliminado");
    } catch (err) {
      console.error("Error al eliminar en el servidor:", err);
    }
  }

  // Borrar también del cliente
  localStorage.removeItem("usuarioCitas");
  userInfo.style.display = "none";
  form.style.display = "flex";
  mensaje.textContent = "";
});} 

// Revisar si ya hay usuario guardado en localStorage
const usuarioGuardado = JSON.parse(localStorage.getItem("usuarioCitas"));
if(usuarioGuardado){
  mostrarUsuario(usuarioGuardado);
}

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const name = document.getElementById("username").value.trim();
  const edad = document.getElementById("edad").value;
  const intereses = document.getElementById("intereses").value; 

  try {
    const res = await fetch("/citas", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({username, edad, intereses, name})
    });
    const data = await res.json();
    if(data.success){
      mensaje.style.color="green";
      mensaje.textContent="✅ Te has unido a las citas!";
      localStorage.setItem("usuarioCitas", JSON.stringify(data.cita)); // Guardar datos
      mostrarUsuario(data.cita);
    }else{
      mensaje.style.color="red";
      mensaje.textContent=data.error || "Ocurrió un error";
    }
  } catch(err){
    mensaje.style.color="red";
    mensaje.textContent="Error de conexión";
  }
});
</script>

</body>
</html>
